# 多种编码方式

基于`CYFS`的所有信息都需要编码用于存储、通信或计算，我们可以从不同的维度对编码方式进行分类：

1. 按各字段在编码`Buffer`中的内存布局分类。
2. 按编码`Buffer`的用途分类。

## 按各字段在编码`Buffer`中的内存布局分类

按内存布局分类可以选择下列三种编码方式其中一种，`Protobuf`和`JSON`都有其标准的编码规范，这里不再赘述，我们只介绍二进制编码格式。

1. 二进制流

    二进制格式编码，通常用于标准化固定编码，最省空间，但不易扩展。

    选用二进制流编码，需要类型设计者按确定顺序逐个字段填入`Buffer`。

2. Protobuf

    用`Protobuf`编码，同时兼顾一定的空间效率和扩展性，这是大部分复杂类型选用的编码方式。

    选用`Protobuf`编码，类型设计者只需要把对象的各个字段赋值给对应`Protobuf`类型，然后使用`Protobuf`方法进行编解码即可，兼容性处理需要参照`Protobuf`规范。

    **注意：我们选用的`Protobuf`规范是`Proto3`，考虑到向后兼容性，`Protobuf`版本也不太可能升级。当然新设计的类型可以选用其他版本，但需要慎重引入不同版本。**

3. JSON

    用 `JSON` 编码，空间效率较低，但可读性好。

    因为其空间效率较低，并且`JSON`编码结果有一定的不确定性（比如，我们可以使用不同的字符进行换行和空格），通常不选择`JSON`方式对信息进行编解码以用于存储和通信。`JSON`编码通常出现在人机交互的场景。

**不管选用哪种编码方式，用于对象编码时都要注意编码的稳定性(如：Set 和 Map 应该注意各元素顺序)，否则相同内容多次计算得到的`ObjectId`可能不同。**

## 按编码`Buffer`的用途分类

-   全编码

这种方式就是简单地把所有信息按特定方式填入`Buffer`。各类型通常都支持这种编码方式。

-   Hash 编码

这种方式通常用在有计算`Hash`需求的类型，当需要计算`Hash`的时候用这种方式进行编码，将结果存放在一个`Buffer`中，再用 **`SHA256`** 对这个`Buffer`求最后的结果，这个结果我们通常把它称作这个**类型的`HASH`**。这是一个可选的编码方式，**不明确说清的情况下，都是直接选用全编码方式来计算`HASH`。**

无论基于何种用途的编码，都可以选用前述`二进制流`和`Protobuf`之一进行编码，`JSON`格式的不确定性决定了它不适合用于`Hash编码`。
